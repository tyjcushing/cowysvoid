<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Print Sheet Builder — Cowy’s Void</title>
  <meta name="description" content="Paste a list of cards, pick arts, set print scale/bleed, and generate a print-ready sheet." />

  <link rel="icon" href="/assets/icons/favicon.ico" sizes="any">
  <link rel="icon" type="image/png" href="/assets/icons/BlackHole.png" sizes="32x32">
  <link rel="stylesheet" href="/assets/css/void.css">

  <style>
    /* Small page-specific additions that sit nicely on top of void.css */
    .ps-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 12px;
      margin-top: 10px;
    }

    .ps-controls {
      display: flex;
      flex-wrap: wrap;
      gap: 10px 14px;
      align-items: center;
      justify-content: space-between;
    }

    .ps-controls .left,
    .ps-controls .right {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
    }

    .control-inline {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 10px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
    }

    .control-inline label {
      font-size: 13px;
      color: var(--muted);
      user-select: none;
      white-space: nowrap;
    }

    .control-inline input[type="number"] {
      width: 84px;
      padding: 8px 10px;
      border-radius: 10px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.22);
      color: var(--text);
      outline: none;
    }

    .control-inline input[type="range"] {
      width: 160px;
    }

    .control-inline select {
      padding: 8px 10px;
      border-radius: 10px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.22);
      color: var(--text);
      outline: none;
    }

    .btn-group {
      display: inline-flex;
      gap: 8px;
      padding: 8px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.16);
    }

    .cards-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(230px, 1fr));
      gap: 12px;
      margin-top: 10px;
    }

    .card-tile {
      display: grid;
      grid-template-columns: 96px 1fr;
      gap: 10px;
      padding: 12px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.14);
      box-shadow: 0 10px 24px rgba(0,0,0,.24);
      overflow: hidden;
    }

    .thumb {
      width: 96px;
      height: 134px;
      border-radius: 14px;
      overflow: hidden;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.06);
    }

    .thumb img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }

    .tile-title {
      display: flex;
      align-items: baseline;
      justify-content: space-between;
      gap: 10px;
    }

    .tile-title strong {
      font-size: 14px;
      line-height: 1.2;
    }

    .tile-meta {
      margin-top: 4px;
      font-size: 12px;
      color: var(--muted);
    }

    .tile-actions {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-top: 10px;
    }

    .mono-pre {
      white-space: pre-wrap;
      word-break: break-word;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 12px;
    }

    /* Modal shell – matches your solid-surface vibe */
    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.68);
      display: none;
      align-items: center;
      justify-content: center;
      padding: 18px;
      z-index: 9999;
    }
    .modal-backdrop.open { display: flex; }
    .modal {
      width: min(980px, 96vw);
      max-height: 88vh;
      overflow: auto;
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(10,10,14,.92);
      box-shadow: 0 18px 44px rgba(0,0,0,.55);
      padding: 14px;
    }
    .modal-head {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      padding: 6px 6px 12px;
      border-bottom: 1px solid rgba(255,255,255,.10);
      margin-bottom: 12px;
    }
    .modal-head h3 { margin: 0; font-size: 16px; }
  </style>
</head>

<body>
  <div id="bgVideo" class="bg-video" aria-hidden="true">
    <video id="bgVideoEl" playsinline muted autoplay loop preload="metadata" poster="/assets/Blackhole_Poster.jpg"></video>
  </div>

  <div class="app-layer">
    <header id="site-header" aria-label="Primary"></header>

    <main class="container">
      <section class="panel page-panel solid-surface">
        <header class="page">
          <h1>Print Sheet Builder</h1>
          <p class="sub">
            Paste card names. We’ll fetch Scryfall data, show images, let you swap art, then build a print-ready sheet.
          </p>
        </header>

        <div class="toolbar toolbar-wide" role="region" aria-label="Paste cards">
          <label class="input input-solid solid-input" style="align-items:start">
            <textarea id="cardInput" class="textarea" placeholder="Examples:
Sol Ring
Dark Ritual
3x Arcane Signet
1 Command Tower
..."></textarea>
          </label>
        </div>

        <div class="controls-row">
          <button id="loadBtn" class="btn">Load</button>
          <button id="clearBtn" class="btn ghost solid-ghost-btn" type="button">Clear</button>

          <span id="spinner" class="spinner" hidden>
            <span class="spin-dot" aria-hidden="true"></span>
            <span class="inline-hint">Loading…</span>
          </span>

          <label class="control" title="Logs raw Scryfall response to the console">
            <input id="debug" type="checkbox">
            Debug JSON
          </label>
        </div>

        <div class="inline-hint">
          Tip: if images ever fail again, it’s almost always CSP. Your site must allow
          <code>img-src https://cards.scryfall.io</code>.
        </div>
      </section>

      <section class="panel solid-surface">
        <h2>Print Settings</h2>

        <div class="ps-controls" style="margin-top:10px">
          <div class="left">
            <span class="control-inline">
              <label for="scalePct"><strong>Scale</strong></label>
              <button id="scaleDown" class="btn ghost solid-ghost-btn" type="button">−</button>
              <input id="scalePct" type="number" min="50" max="140" step="1" value="100" />
              <span class="inline-hint">%</span>
              <button id="scaleUp" class="btn ghost solid-ghost-btn" type="button">+</button>
            </span>

            <span class="control-inline" title="Quick adjust scale">
              <label for="scaleRange">Fine</label>
              <input id="scaleRange" type="range" min="50" max="140" value="100">
            </span>

            <span class="control-inline">
              <label for="bleed"><strong>Bleed / Gap</strong></label>
              <select id="bleed">
                <option value="0">No gap</option>
                <option value="0.2">0.2mm</option>
                <option value="3">3mm</option>
              </select>
            </span>
          </div>

          <!-- Wrapped together as requested -->
          <div class="right">
            <div class="btn-group" aria-label="Build and print">
              <button id="buildBtn" class="btn" type="button">Build Print Sheet</button>
              <button id="printBtn" class="btn ghost solid-ghost-btn" type="button">Print</button>
            </div>
          </div>
        </div>

        <div id="status" class="mono-pre" style="margin-top:10px; opacity:.9"></div>
      </section>

      <section class="panel solid-surface">
        <h2>Cards</h2>
        <div id="empty" class="empty" hidden>Paste cards and click Load.</div>
        <div id="cards" class="cards-grid"></div>
      </section>

      <!-- Hidden print area -->
      <section id="printArea" hidden></section>
    </main>
  </div>

  <!-- Art picker modal shell (hook points; we’ll fill it next) -->
  <div id="artModalBackdrop" class="modal-backdrop" role="dialog" aria-modal="true" aria-label="Choose art">
    <div class="modal solid-surface">
      <div class="modal-head">
        <h3 id="artModalTitle">Choose Art</h3>
        <button id="artModalClose" class="btn ghost solid-ghost-btn" type="button">Close</button>
      </div>
      <div id="artModalBody" class="inline-hint">Coming next: visual list of prints for this card.</div>
    </div>
  </div>

<script>
  // ---------- Parsing ----------
  function stripNameAnnotations(s = '') {
    s = s.trim();
    const cuts = [s.indexOf('['), s.indexOf('{'), s.indexOf('('), s.indexOf('^^')].filter(i => i >= 0);
    if (!cuts.length) return s;
    return s.slice(0, Math.min(...cuts)).trim();
  }

  function parseCardLines(text) {
    const lines = (text || '').replace(/\r\n?/g, '\n').split('\n');
    const out = [];
    for (let raw of lines) {
      let line = (raw || '').trim();
      if (!line) continue;
      line = line.replace(/\s*\/\/.*$/,'').replace(/\s*#.*$/,'').trim();
      if (!line) continue;

      let m = line.match(/^(\d+)\s*x?\s+(.+)$/i);
      if (m) {
        out.push({ qty: parseInt(m[1], 10), name: stripNameAnnotations(m[2]) });
      } else {
        out.push({ qty: 1, name: stripNameAnnotations(line) });
      }
    }
    return out;
  }

  // ---------- Scryfall ----------
  async function fetchCollectionByNames(names) {
    const CHUNK = 70;
    const uniq = [...new Set(names.filter(Boolean))];
    const out = new Map();

    for (let i = 0; i < uniq.length; i += CHUNK) {
      const slice = uniq.slice(i, i + CHUNK);
      const body = { identifiers: slice.map(n => ({ name: n })) };
      const r = await fetch('https://api.scryfall.com/cards/collection', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(body)
      });
      if (!r.ok) {
        console.warn('Scryfall collection error', r.status);
        continue;
      }
      const j = await r.json();
      if (document.getElementById('debug')?.checked) {
        console.log('[DEBUG] /cards/collection JSON:', j);
        console.log('[DEBUG] /cards/collection JSON.stringify:', JSON.stringify(j));
      }
      for (const card of (j.data || [])) out.set(card.name, card);
    }
    return out;
  }

  function getFrontImage(card, version = 'normal') {
    if (!card) return null;
    if (card.image_uris?.[version]) return card.image_uris[version];
    if (Array.isArray(card.card_faces) && card.card_faces[0]?.image_uris?.[version]) return card.card_faces[0].image_uris[version];
    // fallback: redirect image endpoint
    if (card.id) return `https://api.scryfall.com/cards/${card.id}?format=image&version=${encodeURIComponent(version)}`;
    return null;
  }

  // ---------- State ----------
  let LAST_ITEMS = [];
  let LAST_NAME_TO_CARD = new Map();

  const els = {
    input: document.getElementById('cardInput'),
    loadBtn: document.getElementById('loadBtn'),
    clearBtn: document.getElementById('clearBtn'),
    spinner: document.getElementById('spinner'),
    empty: document.getElementById('empty'),
    cards: document.getElementById('cards'),
    status: document.getElementById('status'),

    scalePct: document.getElementById('scalePct'),
    scaleRange: document.getElementById('scaleRange'),
    scaleDown: document.getElementById('scaleDown'),
    scaleUp: document.getElementById('scaleUp'),
    bleed: document.getElementById('bleed'),

    buildBtn: document.getElementById('buildBtn'),
    printBtn: document.getElementById('printBtn'),
    printArea: document.getElementById('printArea'),

    artBackdrop: document.getElementById('artModalBackdrop'),
    artClose: document.getElementById('artModalClose'),
    artTitle: document.getElementById('artModalTitle'),
    artBody: document.getElementById('artModalBody')
  };

  function esc(s) {
    return (s || '').replace(/[&<>\"']/g, m => ({
      '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
    }[m]));
  }

  function setStatus(msg = '') {
    els.status.textContent = msg;
  }

  function setBusy(b) {
    els.spinner.hidden = !b;
  }

  // ---------- Render list ----------
  function renderCards(items, nameToCard) {
    els.cards.innerHTML = '';
    const total = items.reduce((s, it) => s + (it.qty || 1), 0);
    setStatus(`Loaded ${items.length} unique name(s), ${total} total card(s).`);

    for (const it of items) {
      const card = nameToCard.get(it.name);
      const img = getFrontImage(card, 'normal') || getFrontImage(card, 'large') || getFrontImage(card, 'png');
      const setName = (card?.set || '').toUpperCase();
      const cn = card?.collector_number || '—';
      const artist = card?.artist || '—';

      const div = document.createElement('div');
      div.className = 'card-tile';
      div.innerHTML = `
        <div class="thumb">
          ${img ? `<img src="${img}" alt="${esc(it.name)}" loading="lazy" referrerpolicy="no-referrer" crossorigin="anonymous">` : ''}
        </div>
        <div>
          <div class="tile-title">
            <strong>${esc(it.name)}</strong>
            <span class="pill">× <strong>${it.qty || 1}</strong></span>
          </div>
          <div class="tile-meta">${esc(setName)} · #${esc(cn)} · ${esc(artist)}</div>
          <div class="tile-actions">
            <button class="btn ghost solid-ghost-btn" type="button" data-action="art" data-name="${esc(it.name)}">Change Art</button>
          </div>
          <div class="inline-hint" style="margin-top:8px; opacity:.9">
            Image: <code>${esc(img || '—')}</code>
          </div>
        </div>
      `;
      els.cards.appendChild(div);
    }
  }

  // ---------- Load ----------
  async function load() {
    setBusy(true);
    try {
      const items = parseCardLines(els.input.value);
      LAST_ITEMS = items;

      els.empty.hidden = items.length > 0;
      if (!items.length) {
        els.cards.innerHTML = '';
        setStatus('Paste cards and click Load.');
        return;
      }

      const names = [...new Set(items.map(it => it.name))];
      const nameToCard = await fetchCollectionByNames(names);
      LAST_NAME_TO_CARD = nameToCard;

      // Warn if any missing
      const missing = names.filter(n => !nameToCard.get(n));
      if (missing.length) {
        setStatus(
          `Loaded ${names.length - missing.length}/${names.length} unique names.\nMissing:\n- ` +
          missing.slice(0, 20).join('\n- ') +
          (missing.length > 20 ? `\n…and ${missing.length - 20} more` : '')
        );
      }

      renderCards(items, nameToCard);
    } catch (e) {
      console.error(e);
      setStatus(String(e?.message || e));
    } finally {
      setBusy(false);
    }
  }

  // ---------- Art modal (placeholder hook) ----------
  function openArtModal(cardName) {
    els.artTitle.textContent = `Choose Art — ${cardName}`;
    els.artBody.innerHTML = `
      <div class="inline-hint">
        Next step: we’ll call <code>/cards/search?order=released&q=oracleid:...</code> using this card’s <code>oracle_id</code>,
        then render a selectable grid of prints (images) here.
      </div>
    `;
    els.artBackdrop.classList.add('open');
  }
  function closeArtModal() {
    els.artBackdrop.classList.remove('open');
  }

  // ---------- Print sheet (scaffold) ----------
  function buildPrintSheet() {
    if (!LAST_ITEMS.length || !LAST_NAME_TO_CARD.size) {
      setStatus('Load cards first.');
      return;
    }

    const scale = Number(els.scalePct.value || 100) / 100;
    const gapMm = Number(els.bleed.value || 0);

    // For now, we just confirm settings; the next iteration will generate a full print layout.
    // This keeps the “baseline works” behavior while we add the real print geometry.
    setStatus(
      `Print settings:\n- Scale: ${(scale * 100).toFixed(0)}%\n- Gap/Bleed: ${gapMm}mm\n\n` +
      `Next: render a print-ready grid at MTG card size with these settings.`
    );

    // leave printArea empty for now
    els.printArea.hidden = true;
    els.printArea.innerHTML = '';
  }

  function doPrint() {
    // Printing only makes sense after we generate the sheet. We'll keep it safe for now.
    if (!els.printArea.innerHTML.trim()) {
      setStatus('Build the print sheet first.');
      return;
    }
    window.print();
  }

  // ---------- Scale sync ----------
  function clamp(n, a, b) { return Math.max(a, Math.min(b, n)); }
  function syncScaleFromNumber() {
    let v = clamp(parseInt(els.scalePct.value, 10) || 100, 50, 140);
    els.scalePct.value = v;
    els.scaleRange.value = String(v);
  }
  function syncScaleFromRange() {
    let v = clamp(parseInt(els.scaleRange.value, 10) || 100, 50, 140);
    els.scalePct.value = v;
    els.scaleRange.value = String(v);
  }

  // ---------- Events ----------
  document.addEventListener('DOMContentLoaded', () => {
    els.loadBtn.addEventListener('click', load);

    els.clearBtn.addEventListener('click', () => {
      els.input.value = '';
      els.cards.innerHTML = '';
      els.empty.hidden = false;
      setStatus('');
      LAST_ITEMS = [];
      LAST_NAME_TO_CARD = new Map();
    });

    els.scalePct.addEventListener('change', syncScaleFromNumber);
    els.scaleRange.addEventListener('input', syncScaleFromRange);
    els.scaleDown.addEventListener('click', () => {
      els.scalePct.value = String((parseInt(els.scalePct.value, 10) || 100) - 1);
      syncScaleFromNumber();
    });
    els.scaleUp.addEventListener('click', () => {
      els.scalePct.value = String((parseInt(els.scalePct.value, 10) || 100) + 1);
      syncScaleFromNumber();
    });

    els.buildBtn.addEventListener('click', buildPrintSheet);
    els.printBtn.addEventListener('click', doPrint);

    // Delegate tile actions
    els.cards.addEventListener('click', (e) => {
      const btn = e.target.closest('button[data-action]');
      if (!btn) return;
      const act = btn.getAttribute('data-action');
      const name = btn.getAttribute('data-name');
      if (act === 'art') openArtModal(name);
    });

    els.artClose.addEventListener('click', closeArtModal);
    els.artBackdrop.addEventListener('click', (e) => {
      if (e.target === els.artBackdrop) closeArtModal();
    });

    // Initialize scale UI
    syncScaleFromNumber();
  });
</script>

<script>
  // Background video logic (same as your existing pages)
  document.addEventListener('DOMContentLoaded', () => {
    const c = navigator.connection || navigator.mozConnection || navigator.webkitConnection;
    const isFast = !c || (c.effectiveType === '4g' && c.downlink >= 5 && !c.saveData);
    const isWifiLike = !c || (['wifi','ethernet'].includes(c.type || '') || typeof c.type === 'undefined');
    const allowVideo = isFast && isWifiLike;

    const wrap = document.getElementById('bgVideo');
    const vid  = document.getElementById('bgVideoEl');
    if (!wrap || !vid) return;

    if (!allowVideo) {
      wrap.style.display = 'none';
      return;
    }

    vid.src = '/assets/Blackhole_Animtation.mp4';

    const onReady = () => {
      wrap.classList.add('ready');
      const p = vid.play();
      if (p && typeof p.catch === 'function') p.catch(() => {});
    };

    vid.addEventListener('canplay', onReady, { once: true });
    vid.addEventListener('loadeddata', onReady, { once: true });
    vid.addEventListener('loadedmetadata', () => wrap.classList.add('ready'), { once: true });
  });
</script>

<script>
  // Partials loader (same pattern as your Analyzer page)
  (async () => {
    try {
      async function loadPartial(url) {
        const res = await fetch(url, { cache: 'no-store' });
        if (!res.ok) return null;
        const html = await res.text();
        const tpl = document.createElement('template');
        tpl.innerHTML = html.trim();
        tpl.content.querySelectorAll('style').forEach(st => {
          document.head.appendChild(st.cloneNode(true));
          st.remove();
        });
        return tpl.content.firstElementChild || null;
      }

      const header = document.getElementById('site-header');
      const navEl = await loadPartial('/partials/nav.html');
      if (header && navEl) {
        header.innerHTML = '';
        header.appendChild(navEl);
        initNav(header);
      }

      const discordEl = await loadPartial('/partials/discord.html');
      if (discordEl) document.body.appendChild(discordEl);

      const footerEl = await loadPartial('/partials/footer.html');
      if (footerEl) document.body.appendChild(footerEl);

      function initNav(scope) {
        const btn = scope.querySelector('.menu-toggle');
        const panel = scope.querySelector('#nav-panel');
        if (btn && panel) {
          btn.addEventListener('click', () => {
            const open = panel.classList.toggle('open');
            btn.setAttribute('aria-expanded', open ? 'true' : 'false');
          });
        }
        const here = location.pathname.toLowerCase().replace(/\/+$/, '');
        scope.querySelectorAll('.nav-link').forEach(a => {
          let href = (a.getAttribute('href') || '').toLowerCase().replace(/\/+$/, '');
          if (href === '/blog/') href = '/blog';
          if (here === href || ((here === '' || here === '/') && href === '/index.html')) {
            a.setAttribute('aria-current', 'page');
          }
          if (here.includes('/projects')) a.setAttribute('aria-current', 'page');
          if (here.startsWith('/blog') && href === '/blog') a.setAttribute('aria-current', 'page');
        });
      }
    } catch (e) {
      console.warn('Partial load failed:', e);
    }
  })();
</script>
</body>
</html>
