<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Projects — Cowy’s Void</title>
  <meta name="description" content="Project library — searchable cards linking to individual project pages." />

  <!-- Icons -->
  <link rel="icon" href="/assets/icons/favicon.ico" sizes="any">
  <link rel="icon" type="image/png" href="/assets/icons/BlackHole.png" sizes="32x32">

  <!-- Unified styles -->
  <link rel="stylesheet" href="/assets/css/void.css">
</head>
<body>
  <!-- Background video (behind everything) -->
  <div id="bgVideo" class="bg-video" aria-hidden="true">
    <video id="bgVideoEl" playsinline muted autoplay loop preload="metadata" poster="/assets/Blackhole_Poster.jpg"></video>
  </div>

  <!-- Content above the video -->
  <div class="app-layer">
    <header id="site-header" aria-label="Primary"></header>

    <main class="container">
      <header class="page">
        <h1>Projects</h1>
        <p class="sub">Searchable gallery of things I built. Click a card to open the project.</p>
      </header>

      <div class="toolbar" role="search">
        <label class="input" aria-label="Search projects">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <path d="M21 21l-4.35-4.35m1.35-5.65A7 7 0 1 1 5 5a7 7 0 0 1 13 0z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
          </svg>
          <input id="q" placeholder="Search by title, tags, tech, etc." />
        </label>
        <button id="clearBtn" class="btn ghost" type="button">Clear</button>
      </div>

      <div class="filters" id="tagFilters" aria-label="Tag filters"></div>

      <div class="section"><h2>All Projects</h2></div>
      <section id="projGrid" class="grid" aria-live="polite"></section>
      <div id="empty" class="empty" hidden>No projects match your search.</div>
    </main>
  </div><!-- /.app-layer -->

  <!-- Data + UI -->
  <script>
  const state = { all: [], filtered: [], activeTags: new Set() };

  function esc(s){return (s||'').replace(/[&<>\"']/g, m=>({"&":"&amp;","<":"&lt;","&gt;":"&gt;","\"":"&quot;","'":"&#39;"}[m]))}

  async function loadProjects(){
    const res = await fetch('/data/projects.json', { cache: 'no-store' });
    if(!res.ok) throw new Error('Failed to load projects.json');
    state.all = (await res.json()) || [];

    // normalize + sort
    state.all.forEach((p,i)=>{ p._idx=i; });
    state.all.sort((a,b)=>{
      const ad = new Date(a.updated||0).getTime(), bd = new Date(b.updated||0).getTime();
      if (bd - ad) return bd - ad;
      return (a.title||'').localeCompare(b.title||'');
    });

    state.filtered = state.all.slice();
    buildTagChips();
    render();
  }

  function templateCard(p){
    const title = esc(p.title||'Untitled');
    const url   = esc(p.url||'#');
    const blurb = esc(p.blurb||'');
    const tags  = Array.isArray(p.tags) ? p.tags.map(esc) : [];
    const tech  = Array.isArray(p.tech) ? p.tech.map(esc) : [];
    const updated = p.updated ? new Date(p.updated).toLocaleDateString() : '';

    const img = esc(p.image||'');
    const thumb = img
      ? `<div class="thumbwrap"><img class="thumb" src="${img}" alt="${title} preview"></div>`
      : `<div class="thumbwrap"><div class="thumb fallback">${title.charAt(0).toUpperCase()}</div></div>`;

    const meta = [];
    if (tech.length) meta.push(`<span>${tech.join(' • ')}</span>`);
    if (updated) meta.push(`<span>Updated: ${updated}</span>`);

    return `
      <article class="card project-card" data-url="${url}" tabindex="0" role="button" aria-label="Open ${title}">
        ${thumb}
        <div class="body">
          <div class="title-row">
            <h3>${title}${p.subtitle?`<span class="subtitle">${esc(p.subtitle)}</span>`:''}</h3>
          </div>
          ${blurb?`<div class="blurb">${blurb}</div>`:''}
          ${meta.length?`<div class="meta">${meta.join('')}</div>`:''}
          ${tags.length?`<div class="meta">${tags.map(t=>`<span class="pill">${t}</span>`).join('')}</div>`:''}
        </div>
      </article>`;
  }

  function render(){
    const grid = document.getElementById('projGrid');
    if(!state.filtered.length){
      grid.innerHTML = '';
      document.getElementById('empty').hidden = false;
      return;
    }
    document.getElementById('empty').hidden = true;
    grid.innerHTML = state.filtered.map(templateCard).join('');

    // Click + keyboard open
    grid.querySelectorAll('.card').forEach(el=>{
      el.addEventListener('click', ()=>{ const u = el.getAttribute('data-url'); if(u) location.href = u; });
      el.addEventListener('keydown', (e)=>{ if(e.key==='Enter' || e.key===' '){ e.preventDefault(); const u = el.getAttribute('data-url'); if(u) location.href = u; } });
    });
  }

  function buildTagChips(){
    const allTags = new Set();
    state.all.forEach(p => (p.tags||[]).forEach(t => allTags.add(t)));
    const list = document.getElementById('tagFilters');
    list.innerHTML = '';
    [...allTags].sort().forEach(tag => {
      const chip = document.createElement('button');
      chip.type = 'button';
      chip.className = 'chip';
      chip.textContent = tag;
      chip.addEventListener('click', () => {
        if(state.activeTags.has(tag)) state.activeTags.delete(tag); else state.activeTags.add(tag);
        chip.classList.toggle('active');
        applyFilters();
      });
      list.appendChild(chip);
    });
  }

  function applyFilters(){
    const q = document.getElementById('q').value.trim().toLowerCase();
    const tags = state.activeTags;
    state.filtered = state.all.filter(p => {
      const ptags = new Set(p.tags||[]);
      if (tags.size && ![...tags].every(t => ptags.has(t))) return false;

      if (!q) return true;
      const hay = [p.title, p.subtitle, p.blurb, (p.tags||[]).join(' '), (p.tech||[]).join(' ')].join(' ').toLowerCase();
      return hay.includes(q);
    });

    // sort: if query exists, prefer title asc; else updated desc
    if (q){
      state.filtered.sort((a,b)=> (a.title||'').localeCompare(b.title||'') || (a._idx-b._idx));
    } else {
      state.filtered.sort((a,b)=>{
        const ad = new Date(a.updated||0).getTime(), bd = new Date(b.updated||0).getTime();
        if (bd - ad) return bd - ad;
        return (a.title||'').localeCompare(b.title||'') || (a._idx-b._idx);
      });
    }

    render();
  }

  document.addEventListener('DOMContentLoaded', async () => {
    try{ await loadProjects(); }catch(e){ console.warn(e); }
    const q = document.getElementById('q');
    const clearBtn = document.getElementById('clearBtn');
    q.addEventListener('input', applyFilters);
    clearBtn.addEventListener('click', ()=>{ 
      q.value=''; state.activeTags.clear(); 
      document.querySelectorAll('.chip.active').forEach(c=>c.classList.remove('active')); 
      applyFilters(); 
    });
  });
  </script>

  <!-- Background video loader -->
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const c = navigator.connection || navigator.mozConnection || navigator.webkitConnection;
      const isFast = !c || (c.effectiveType === '4g' && c.downlink >= 5 && !c.saveData);
      const isWifiLike = !c || (['wifi','ethernet'].includes(c.type || '') || typeof c.type === 'undefined');
      const allowVideo = isFast && isWifiLike;

      const wrap = document.getElementById('bgVideo');
      const vid  = document.getElementById('bgVideoEl');
      if (!wrap || !vid) return;

      if (!allowVideo) {
        wrap.style.display = 'none';
        return;
      }

      vid.src = '/assets/Blackhole_Animtation.mp4';

      const onReady = () => {
        wrap.classList.add('ready');
        const p = vid.play();
        if (p && typeof p.catch === 'function') p.catch(() => {});
      };

      vid.addEventListener('canplay', onReady, { once: true });
      vid.addEventListener('loadeddata', onReady, { once: true });
      vid.addEventListener('loadedmetadata', () => { wrap.classList.add('ready'); }, { once: true });
    });
  </script>

  <!-- Partials injector -->
  <script>
  (async () => {
    try {
      async function loadPartial(url) {
        const res = await fetch(url, { cache: 'no-store' });
        if (!res.ok) return null;
        const html = await res.text();
        const tpl = document.createElement('template');
        tpl.innerHTML = html.trim();
        tpl.content.querySelectorAll('style').forEach(st => { document.head.appendChild(st.cloneNode(true)); st.remove(); });
        return tpl.content.firstElementChild || null;
      }
      const header = document.getElementById('site-header');
      const navEl = await loadPartial('/partials/nav.html');
      if (header && navEl) { header.innerHTML = ''; header.appendChild(navEl); initNav(header); }
      const discordEl = await loadPartial('/partials/discord.html');
      if (discordEl) document.body.appendChild(discordEl);
      const footerEl = await loadPartial('/partials/footer.html');
      if (footerEl) document.body.appendChild(footerEl);

      function initNav(scope) {
        const btn = scope.querySelector('.menu-toggle');
        const panel = scope.querySelector('#nav-panel');
        if (btn && panel) {
          btn.addEventListener('click', () => {
            const open = panel.classList.toggle('open');
            btn.setAttribute('aria-expanded', open ? 'true' : 'false');
          });
        }
        const here = location.pathname.toLowerCase().replace(/\/+$/, '');
        scope.querySelectorAll('.nav-link').forEach(a => {
          let href = (a.getAttribute('href') || '').toLowerCase().replace(/\/+$/, '');
          if (href === '/blog/') href = '/blog';
          if (here === href || ((here === '' || here === '/') && href === '/index.html')) a.setAttribute('aria-current', 'page');
          if (here.includes('/projects')) a.setAttribute('aria-current', 'page'); // highlight projects
          if (here.startsWith('/blog') && href === '/blog') a.setAttribute('aria-current', 'page');
        });
      }
    } catch (e) { console.warn('Partial load failed:', e); }
  })();
  </script>
</body>
</html>
